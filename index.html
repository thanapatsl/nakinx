<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaPatra - ‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πâ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï & Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Sarabun', sans-serif;
        }
        
        @media print {
            .no-print { display: none !important; }
            .customer-list-section { display: none !important; }
            body { font-size: 12px; }
            .print-table { font-size: 11px; }
            .page-break { page-break-after: always; }
        }
        
        .kbank-green { background-color: #138f2d; }
        .kbank-green-light { background-color: #e8f5e8; }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Main Application -->
    <div id="mainApp" class="container mx-auto p-4 max-w-7xl">
        <!-- Customer Management Dashboard -->
        <div class="bg-white rounded-lg shadow-lg mb-6 p-6 customer-list-section">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-xl">üíº</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏±‡πâ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï AlphaPatra</h1>
                        <p class="text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πâ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï ‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
                        <div class="mt-3 flex flex-wrap items-center gap-4">
                            <div class="flex items-center space-x-3">
                                <span class="text-lg font-semibold text-blue-700">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span>
                                <div id="totalAllAccounts" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-2 rounded-lg font-bold text-lg shadow-lg">
                                    0.00
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-sm text-gray-500">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                <span class="text-xl font-bold text-blue-600" id="customerCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row md:items-center gap-2">
                    <button onclick="openOverview()" class="no-print bg-purple-600 hover:bg-purple-700 text-white px-5 py-3 rounded-lg transition-colors flex items-center space-x-2 shadow-lg">
                        <span>üìä</span>
                        <span class="font-medium">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </button>
                    <button onclick="addNewCustomer()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-lg transition-colors flex items-center space-x-2 shadow-lg">
                        <span>‚ûï</span>
                        <span class="font-medium">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
                    </button>
                </div>
            </div>

            <!-- Customer Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="customerList">
                <!-- Cards by JS -->
            </div>
        </div>

        <!-- Modal: ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + Dashboard AlphaPatra -->
        <div id="overviewModal"
             class="fixed inset-0 bg-black bg-opacity-40 hidden z-50"
             onclick="if (event.target === this) closeOverview();">
            <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col"
                 onclick="event.stopPropagation();">
                <div class="px-6 pt-5 pb-3 border-b border-gray-200 flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                        <p class="text-sm text-gray-500">
                            ‡∏î‡∏π‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô (%) ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÉ‡∏ô AlphaPatra
                        </p>
                    </div>
                    <button onclick="closeOverview()" class="no-print px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium">
                        ‚úï ‡∏õ‡∏¥‡∏î
                    </button>
                </div>

                <div class="px-6 pt-4 pb-5 overflow-y-auto">
                    <!-- Summary cards -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-4">
                        <div class="bg-indigo-50 rounded-xl p-3">
                            <div class="text-xs text-indigo-600 font-semibold mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
                            <div class="text-2xl font-bold text-indigo-700" id="overviewTotalCustomers">0</div>
                        </div>
                        <div class="bg-emerald-50 rounded-xl p-3">
                            <div class="text-xs text-emerald-600 font-semibold mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            <div class="text-lg font-semibold text-emerald-700" id="overviewSumInitial">0.00</div>
                        </div>
                        <div class="bg-blue-50 rounded-xl p-3">
                            <div class="text-xs text-blue-600 font-semibold mb-1">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏£‡∏ß‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                            <div class="text-lg font-semibold text-blue-700" id="overviewSumFinal">0.00</div>
                        </div>
                        <div class="bg-amber-50 rounded-xl p-3">
                            <div class="text-xs text-amber-600 font-semibold mb-1">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            <div class="text-lg font-semibold text-emerald-600" id="overviewSumProfit">0.00</div>
                        </div>
                        <!-- ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
                        <div class="bg-rose-50 rounded-xl p-3">
                            <div class="flex items-center justify-between mb-1">
                                <div class="text-xs text-rose-600 font-semibold">‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                                <div class="flex items-center space-x-1 text-[10px] text-rose-600">
                                    <select id="monthlyMonth"
                                            onchange="updateMonthlyProfit()"
                                            class="border border-rose-200 rounded px-1 py-[1px] bg-white focus:outline-none focus:ring-1 focus:ring-rose-400">
                                        <option value="1">‡∏°.‡∏Ñ.</option>
                                        <option value="2">‡∏Å.‡∏û.</option>
                                        <option value="3">‡∏°‡∏µ.‡∏Ñ.</option>
                                        <option value="4">‡πÄ‡∏°.‡∏¢.</option>
                                        <option value="5">‡∏û.‡∏Ñ.</option>
                                        <option value="6">‡∏°‡∏¥.‡∏¢.</option>
                                        <option value="7">‡∏Å.‡∏Ñ.</option>
                                        <option value="8">‡∏™.‡∏Ñ.</option>
                                        <option value="9">‡∏Å.‡∏¢.</option>
                                        <option value="10">‡∏ï.‡∏Ñ.</option>
                                        <option value="11">‡∏û.‡∏¢.</option>
                                        <option value="12">‡∏ò.‡∏Ñ.</option>
                                    </select>
                                    <select id="monthlyYear"
                                            onchange="updateMonthlyProfit()"
                                            class="border border-rose-200 rounded px-1 py-[1px] bg-white focus:outline-none focus:ring-1 focus:ring-rose-400">
                                        <!-- ‡∏û‡πà‡∏≠‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î‡∏õ‡∏µ‡πÄ‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ -->
                                        <option value="2567">2567</option>
                                        <option value="2568">2568</option>
                                        <option value="2569">2569</option>
                                        <option value="2570">2570</option>
                                    </select>
                                </div>
                            </div>
                            <div id="overviewMonthlyLabel" class="text-[10px] text-rose-400 mb-1"></div>
                            <div class="text-lg font-semibold text-rose-700" id="overviewMonthlyProfit">0.00</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Table -->
                        <div class="border border-gray-200 rounded-xl overflow-hidden">
                            <div class="px-3 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                                <span class="text-sm font-semibold text-gray-700">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
                                <span class="text-xs text-gray-500">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á</span>
                            </div>
                            <div class="max-h-72 overflow-y-auto">
                                <table class="min-w-full text-xs">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-2 py-2 text-left text-[11px] font-semibold text-gray-500">#</th>
                                            <th class="px-2 py-2 text-left text-[11px] font-semibold text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                            <th class="px-2 py-2 text-right text-[11px] font-semibold text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
                                            <th class="px-2 py-2 text-right text-[11px] font-semibold text-gray-500">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                            <th class="px-2 py-2 text-right text-[11px] font-semibold text-gray-500">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                                            <th class="px-2 py-2 text-right text-[11px] font-semibold text-gray-500">‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="overviewTableBody" class="bg-white divide-y divide-gray-100">
                                        <!-- rows by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Chart -->
                        <div class="border border-gray-200 rounded-xl p-3 flex flex-col">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-gray-700">Dashboard AlphaPatra</span>
                                <span class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
                            </div>
                            <div class="flex-1">
                                <canvas id="overviewChart" height="220"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statement View Section (Hidden by default) -->
        <div id="statementSection" class="hidden">
            <!-- Navigation Bar -->
            <div class="bg-white rounded-lg shadow-lg mb-4 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="showCustomerList()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
                            <span>‚Üê</span>
                            <span>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
                        </button>
                        <div class="h-6 w-px bg-gray-300"></div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-800" id="currentCustomerName">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
                            <p class="text-sm text-gray-600">‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πâ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 no-print">
                        <button onclick="renameCurrentCustomer()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ‚úèÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠
                        </button>
                        <button onclick="deleteCurrentCustomer()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                            üóëÔ∏è ‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                        </button>
                    </div>
                </div>
            </div>

            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg mb-6 p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <div id="logoContainer" class="w-12 h-12 kbank-green rounded-lg flex items-center justify-center cursor-pointer hover:bg-green-700 transition-colors" onclick="document.getElementById('logoInput').click()">
                                <span id="logoText" class="text-white font-bold text-xl">K</span>
                                <img id="logoImage" class="w-12 h-12 rounded-lg object-cover hidden" alt="Bank Logo">
                            </div>
                            <input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                        </div>
                        <input type="text" id="reportTitle" value="‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πâ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï" class="text-2xl font-bold text-gray-800 bg-transparent border-none focus:outline-none focus:ring-2 focus:ring-green-500 focus:bg-white rounded px-2 py-1">
                    </div>
                    <div class="no-print flex space-x-2">
                        <!-- Export Menu -->
                        <div class="relative">
                            <button onclick="toggleExportMenu()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                                üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
                                <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="exportMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                <div class="py-2">
                                    <button onclick="exportAsImage('png')" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center">
                                        üñºÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PNG
                                    </button>
                                    <button onclick="exportAsImage('jpeg')" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center">
                                        üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô JPEG
                                    </button>
                                    <hr class="my-1">
                                    <button onclick="exportCSV()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center">
                                        üìä Export CSV
                                    </button>
                                    <button onclick="window.print()" class="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center">
                                        üñ®Ô∏è Print PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <input type="file" id="csvInput" accept=".csv" style="display: none;" onchange="importCSV(event)">
                        <button onclick="document.getElementById('csvInput').click()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            üìÅ Import CSV
                        </button>
                    </div>
                </div>
                
                <!-- Bank Info Form -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô</label>
                        <input type="text" id="bankName" value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏´‡∏∏‡πâ‡∏ô</label>
                        <input
                            type="text"
                            id="accountNo"
                            value="‡∏ô‡∏≤‡∏¢‡∏ò‡∏ô‡∏†‡∏±‡∏ó‡∏£ ‡∏®‡∏≤‡∏•‡∏≤‡∏á‡∏≤‡∏° (‡∏≠‡∏±‡∏•‡∏ü‡πà‡∏≤‡∏†‡∏±‡∏ó‡∏£ AlphaPatra)"
                            readonly
                            class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700"
                        >
                    </div>
                </div>

                <!-- Summary Balance -->
                <div class="mt-4 flex justify-start items-start">
                    <div class="flex space-x-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏£‡∏ß‡∏°‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</label>
                            <div id="initialInvestment" class="w-64 p-3 bg-red-50 border-2 border-red-300 rounded-lg text-center font-bold text-lg text-red-700">
                                0.00
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
                            <div id="finalBalance" class="w-64 p-3 bg-green-50 border-2 border-green-300 rounded-lg text-center font-bold text-lg text-green-700">
                                0.00
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction Table -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="p-4 kbank-green-light border-b">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏±‡πâ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï</h2>
                        <button onclick="addRow()" class="no-print bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full print-table">
                        <thead class="kbank-green text-white">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="px-3 py-3 text-right text-xs font-medium uppercase tracking-wider">‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="px-3 py-3 text-right text-xs font-medium uppercase tracking-wider">‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="px-3 py-3 text-right text-xs font-medium uppercase tracking-wider">‡∏Å‡∏≥‡πÑ‡∏£ %</th>
                                <th class="px-3 py-3 text-right text-xs font-medium uppercase tracking-wider">‡∏Å‡∏≥‡πÑ‡∏£ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                                <th class="px-3 py-3 text-right text-xs font-medium uppercase tracking-wider">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                <th class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTable" class="bg-white divide-y divide-gray-200">
                            <!-- Rows by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AlphaProfit ‚Äì ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£ (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) -->
            <div class="bg-white rounded-lg shadow-lg mt-6 p-6">
                <div class="flex flex-col md:flex-row md:space-x-6">
                    <!-- Input side -->
                    <div class="md:w-1/2">
                        <h3 class="text-lg font-semibold text-gray-800 mb-1">
                            üí∞ AlphaProfit ‚Äì ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ 50/50 ‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πâ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï
                        </p>

                        <div class="space-y-4">
                            <div>
                                <label for="ap_total" class="block text-sm font-medium text-gray-700 mb-1">
                                    üìä ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏±‡πâ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï)
                                </label>
                                <input
                                    id="ap_total"
                                    type="number"
                                    step="0.01"
                                    readonly
                                    placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô"
                                    class="w-full p-2.5 border border-gray-200 rounded-lg bg-gray-50 text-gray-700"
                                >
                                <p class="text-xs text-gray-400 mt-1">
                                    ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å: ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                                </p>
                            </div>

                            <div>
                                <label for="ap_fund" class="block text-sm font-medium text-gray-700 mb-1">
                                    üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
                                </label>
                                <input
                                    id="ap_fund"
                                    type="number"
                                    step="0.01"
                                    readonly
                                    placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô"
                                    class="w-full p-2.5 border border-gray-200 rounded-lg bg-gray-50 text-gray-700"
                                >
                                <p class="text-xs text-gray-400 mt-1">
                                    ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å: ‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏£‡∏ß‡∏°‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
                                </p>
                            </div>

                            <p class="text-xs text-emerald-600">
                                ‚úÖ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                            </p>
                        </div>
                    </div>

                    <!-- Result side -->
                    <div class="md:w-1/2 mt-6 md:mt-0">
                        <div
                            id="ap_result"
                            class="hidden border border-gray-200 rounded-xl bg-gray-50 p-4 md:p-5 shadow-sm"
                        >
                            <!-- Filled by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Address -->
            <div class="mt-6 flex justify-end">
                <div class="text-right text-sm text-gray-700">
                    <div class="font-semibold text-green-700 mb-1">‡∏≠‡∏±‡∏•‡∏ü‡πà‡∏≤‡∏†‡∏±‡∏ó‡∏£ AlphaPatra</div>
                    <div>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 85/1 ‡∏´‡∏°‡∏π‡πà 12 ‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏∞‡πÅ‡∏Å</div>
                    <div>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏™‡∏ï‡∏∂‡∏Å ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå 31150</div>
                    <div class="font-medium text-blue-600">(0863019724)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
        // ==========================
        let currentLoggedUser = 'admin';
        let currentUserRole = 'admin';

        let currentPageId = 1;
        let pages = {};
        let transactions = [];
        let overviewChart = null;

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ==========================
        // Helper ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        // ==========================
        function toNum(value) {
            if (value === "" || value === null || value === undefined) return 0;
            const num = typeof value === "string" ? parseFloat(value.replace(/,/g, "")) : value;
            return isNaN(num) ? 0 : num;
        }

        function formatNumber(num) {
            if (num === "" || isNaN(Number(num))) return "";
            return Number(num).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function normalizeNumber(val) {
            if (val === "") return "";
            const cleaned = val.replace(/[^0-9.]/g, "");
            const parts = cleaned.split(".");
            if (parts.length > 2) {
                return parts[0] + "." + parts.slice(1).join("");
            }
            return cleaned;
        }

        // ==========================
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ï‡πà‡∏≠ 1 ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        // ==========================
        function computeCustomerFinalBalance(transactions) {
            let runningBalance = 0;

            transactions.forEach(transaction => {
                const deposit = toNum(transaction.item);
                const withdraw = toNum(transaction.debit);
                const profitPercent = toNum(transaction.credit);

                const base = runningBalance;
                let profitAmount = 0;

                if (profitPercent !== 0) {
                    profitAmount = base * (profitPercent / 100);
                }

                runningBalance = base + deposit - withdraw + profitAmount;
            });

            return runningBalance;
        }

        // ==========================
        // ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
        // ==========================
        function calculateTotalAllAccounts() {
            let totalBalance = 0;
            
            Object.values(pages).forEach(customer => {
                const customerBalance = computeCustomerFinalBalance(customer.transactions);
                totalBalance += customerBalance;
            });
            
            const totalElement = document.getElementById('totalAllAccounts');
            if (totalElement) {
                totalElement.textContent = formatNumber(totalBalance);
                
                if (totalBalance >= 0) {
                    totalElement.className = 'bg-gradient-to-r from-green-500 to-blue-600 text-white px-4 py-2 rounded-lg font-bold text-lg shadow-lg';
                } else {
                    totalElement.className = 'bg-gradient-to-r from-red-500 to-orange-600 text-white px-4 py-2 rounded-lg font-bold text-lg shadow-lg';
                }
            }
            
            return totalBalance;
        }

        // ==========================
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ LocalStorage
        // ==========================
        function saveUserData() {
            saveCurrentPageData();
            localStorage.setItem('pages', JSON.stringify(pages));
            localStorage.setItem('currentPageId', currentPageId.toString());
        }

        function loadUserData() {
            const savedPages = localStorage.getItem('pages');
            const savedCurrentPageId = localStorage.getItem('currentPageId');
            
            if (savedPages) {
                pages = JSON.parse(savedPages);
                currentPageId = savedCurrentPageId ? parseInt(savedCurrentPageId) : parseInt(Object.keys(pages)[0]);
            } else {
                currentPageId = 1;
                pages = {
                    1: {
                        id: 1,
                        name: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1",
                        reportTitle: "‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πâ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï",
                        bankName: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢",
                        accountNo: "",
                        transactions: [
                            { id: generateId(), date: "", item: "", debit: "", credit: "", channel: "", detail: "", profitAmount: 0 }
                        ]
                    }
                };
            }
            
            transactions = pages[currentPageId].transactions;
            loadPageData();
        }

        // ==========================
        // ‡∏™‡∏•‡∏±‡∏ö View
        // ==========================
        function showCustomerList() {
            document.querySelector('.customer-list-section').style.display = 'block';
            document.getElementById('statementSection').classList.add('hidden');
        }

        function showStatementView(customerId) {
            document.querySelector('.customer-list-section').style.display = 'none';
            document.getElementById('statementSection').classList.remove('hidden');
            
            const customer = pages[customerId];
            document.getElementById('currentCustomerName').textContent = customer.name;
            switchToCustomer(customerId);
        }

        // ==========================
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        // ==========================
        function renderCustomerList() {
            const customerContainer = document.getElementById('customerList');
            const customerCountSpan = document.getElementById('customerCount');
            
            customerCountSpan.textContent = Object.keys(pages).length;
            calculateTotalAllAccounts();
            
            customerContainer.innerHTML = Object.values(pages).map((customer, index) => {
                const customerBalance = computeCustomerFinalBalance(customer.transactions);
                
                return `
                <div class="bg-gradient-to-br from-white to-gray-50 border-2 border-gray-200 rounded-xl p-6 transition-all hover:shadow-lg hover:border-blue-300 cursor-pointer group"
                     onclick="showStatementView(${customer.id})">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full flex items-center justify-center text-base font-bold shadow-lg">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-bold text-gray-800 text-base group-hover:text-blue-600 transition-colors line-clamp-1">${customer.name}</div>
                                <div class="text-xs text-gray-500">ID: ${customer.id}</div>
                            </div>
                        </div>
                        <div class="flex space-x-1">
                            <button onclick="renameCustomer(${customer.id}); event.stopPropagation();" 
                                    class="text-blue-600 hover:text-blue-800 p-1.5 rounded-lg hover:bg-blue-50 transition-colors text-sm" 
                                    title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠">
                                ‚úèÔ∏è
                            </button>
                            ${Object.keys(pages).length > 1 ? `
                                <button onclick="deleteCustomer(${customer.id}); event.stopPropagation();" 
                                        class="text-red-600 hover:text-red-800 p-1.5 rounded-lg hover:bg-red-50 transition-colors text-sm" 
                                        title="‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                                    üóëÔ∏è
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 pt-3 space-y-1">
                        <div class="flex items-center justify-between text-xs text-gray-600">
                            <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                            <span class="font-semibold">${customer.transactions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-600">
                            <span>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
                            <span class="font-bold ${customerBalance >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${formatNumber(customerBalance)}
                            </span>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                            <span>${new Date().toLocaleDateString('th-TH')}</span>
                        </div>
                    </div>
                    
                    <div class="mt-3 flex items-center justify-center">
                        <div class="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg text-xs font-medium group-hover:bg-green-200 transition-colors">
                            üìÑ ‡∏î‡∏π‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function addNewCustomer() {
            const customerCount = Object.keys(pages).length + 1;
            const newCustomerName = prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà:', `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${customerCount}`);
            if (!newCustomerName || !newCustomerName.trim()) return;
            
            const newId = Math.max(...Object.keys(pages).map(Number)) + 1;
            pages[newId] = {
                id: newId,
                name: newCustomerName.trim(),
                reportTitle: "‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πâ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï",
                bankName: newCustomerName.trim(),
                accountNo: "",
                transactions: [
                    { id: generateId(), date: "", item: "", debit: "", credit: "", channel: "", detail: "", profitAmount: 0 }
                ]
            };
            
            renderCustomerList();
            saveUserData();
            showStatementView(newId);
        }

        function renameCurrentCustomer() {
            renameCustomer(currentPageId);
            document.getElementById('currentCustomerName').textContent = pages[currentPageId].name;
        }

        function deleteCurrentCustomer() {
            if (Object.keys(pages).length <= 1) {
                alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô');
                return;
            }
            
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ "${pages[currentPageId].name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£`)) {
                delete pages[currentPageId];
                
                const remainingCustomers = Object.keys(pages);
                currentPageId = parseInt(remainingCustomers[0]);
                transactions = pages[currentPageId].transactions;
                
                saveUserData();
                showCustomerList();
                renderCustomerList();
            }
        }

        function deleteCustomer(customerId) {
            if (Object.keys(pages).length <= 1) {
                alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô');
                return;
            }
            
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ "${pages[customerId].name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£`)) {
                delete pages[customerId];
                renderCustomerList();
                saveUserData();
            }
        }

        function switchToCustomer(customerId) {
            saveCurrentPageData();
            currentPageId = customerId;
            transactions = pages[currentPageId].transactions;
            loadPageData();
            renderTable();
            saveUserData();
        }

        function renameCustomer(customerId) {
            const currentName = pages[customerId].name;
            const newName = prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:', currentName);
            if (newName && newName.trim() && newName.trim() !== currentName) {
                pages[customerId].name = newName.trim();
                renderCustomerList();
                saveUserData();
            }
        }

        function saveCurrentPageData() {
            if (pages[currentPageId]) {
                pages[currentPageId].reportTitle = document.getElementById('reportTitle').value;
                pages[currentPageId].bankName = document.getElementById('bankName').value;
                pages[currentPageId].transactions = [...transactions];
            }
        }

        function loadPageData() {
            const page = pages[currentPageId];
            document.getElementById('reportTitle').value = page.reportTitle;
            document.getElementById('bankName').value = page.bankName;
            
            setTimeout(() => {
                calculateBalances();
            }, 100);
        }

        // ==========================
        // Dropdown ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        // ==========================
        function getUniqueValues(field) {
            const allValues = [];
            Object.values(pages).forEach(page => {
                page.transactions.forEach(transaction => {
                    if (transaction[field] && transaction[field].trim()) {
                        allValues.push(transaction[field].trim());
                    }
                });
            });
            return [...new Set(allValues)].sort();
        }

        function createDropdownInput(value, index, field, placeholder = '') {
            const uniqueValues = getUniqueValues(field);
            const dropdownId = `dropdown-${field}-${index}`;
            
            return `
                <div class="relative">
                    <input type="text" 
                           value="${value}" 
                           onchange="updateTransaction(${index}, '${field}', this.value)"
                           onfocus="showDropdown('${dropdownId}')"
                           onblur="setTimeout(() => hideDropdown('${dropdownId}'), 200)"
                           oninput="filterDropdown('${dropdownId}', this.value)"
                           placeholder="${placeholder}"
                           class="w-full p-1 border border-gray-200 rounded focus:ring-1 focus:ring-green-500 focus:border-transparent">
                    ${uniqueValues.length > 0 ? `
                        <div id="${dropdownId}" class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto mt-1">
                            ${uniqueValues.map(val => `
                                <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0" 
                                     onclick="selectDropdownValue('${dropdownId}', ${index}, '${field}', '${val.replace(/'/g, "\\'")}')">
                                    ${val}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function showDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) dropdown.classList.remove('hidden');
        }

        function hideDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) dropdown.classList.add('hidden');
        }

        function filterDropdown(dropdownId, inputValue) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            const items = dropdown.querySelectorAll('div');
            const searchTerm = inputValue.toLowerCase();
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function selectDropdownValue(dropdownId, index, field, value) {
            const input = document.getElementById(dropdownId).previousElementSibling;
            input.value = value;
            updateTransaction(index, field, value);
            hideDropdown(dropdownId);
        }

        // ==========================
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î / ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï AlphaProfit
        // ==========================
        function calculateBalances() {
            let initialInvestment = 0;
            transactions.forEach(transaction => {
                initialInvestment += toNum(transaction.item);
            });

            const initialInvestmentElement = document.getElementById('initialInvestment');
            if (initialInvestmentElement) {
                initialInvestmentElement.textContent = formatNumber(initialInvestment);
            }
            
            let runningBalance = 0;
            const balances = [];
            
            transactions.forEach((transaction, index) => {
                const deposit = toNum(transaction.item);
                const withdraw = toNum(transaction.debit);
                const profitPercent = toNum(transaction.credit);

                const base = runningBalance;
                let profitAmount = 0;

                if (profitPercent !== 0) {
                    profitAmount = base * (profitPercent / 100);
                }

                transaction.profitAmount = profitAmount;

                runningBalance = base + deposit - withdraw + profitAmount;
                balances[index] = runningBalance;
            });
            
            updateFinalBalance(balances);
            updateAlphaProfitFromSummary();
            return balances;
        }

        function updateFinalBalance(balances) {
            const finalBalanceElement = document.getElementById('finalBalance');
            if (finalBalanceElement) {
                const lastBalance = balances.length > 0 ? balances[balances.length - 1] : 0;
                finalBalanceElement.textContent = formatNumber(lastBalance);
                
                if (lastBalance >= 0) {
                    finalBalanceElement.className = 'w-64 p-3 bg-green-50 border-2 border-green-300 rounded-lg text-center font-bold text-lg text-green-700';
                } else {
                    finalBalanceElement.className = 'w-64 p-3 bg-red-50 border-2 border-red-300 rounded-lg text-center font-bold text-lg text-red-700';
                }
            }
        }

        function updateAlphaProfitFromSummary() {
            const finalEl = document.getElementById('finalBalance');
            const initialEl = document.getElementById('initialInvestment');
            const totalInput = document.getElementById('ap_total');
            const fundInput = document.getElementById('ap_fund');
            const resultDiv = document.getElementById('ap_result');

            if (!finalEl || !initialEl || !totalInput || !fundInput) return;

            const total = toNum(finalEl.textContent || finalEl.innerText || '0');
            const fund = toNum(initialEl.textContent || initialEl.innerText || '0');

            totalInput.value = total ? total.toFixed(2) : '';
            fundInput.value = fund ? fund.toFixed(2) : '';

            if (total > 0 || fund > 0) {
                calcProfit();
            } else if (resultDiv) {
                resultDiv.classList.add('hidden');
            }
        }

        // ==========================
        // Render Table
        // ==========================
        function renderTable() {
            const tbody = document.getElementById('transactionTable');
            const balances = calculateBalances();
            
            tbody.innerHTML = transactions.map((transaction, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-4 whitespace-nowrap">
                        <input type="date" value="${transaction.date}" 
                               onchange="updateTransaction(${index}, 'date', this.value)"
                               class="w-full p-1 border border-gray-200 rounded focus:ring-1 focus:ring-green-500 focus:border-transparent">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-right">
                        <input type="text" value="${transaction.item}" 
                               onchange="updateTransaction(${index}, 'item', this.value)"
                               class="w-full p-1 border border-gray-200 rounded text-right focus:ring-1 focus:ring-green-500 focus:border-transparent"
                               placeholder="0.00">
                        <div class="text-xs text-blue-600 mt-1">
                            ${transaction.item ? formatNumber(transaction.item) : ''}
                        </div>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-right">
                        <input type="text" value="${transaction.debit}" 
                               onchange="updateTransaction(${index}, 'debit', this.value)"
                               class="w-full p-1 border border-gray-200 rounded text-right focus:ring-1 focus:ring-green-500 focus:border-transparent"
                               placeholder="0.00">
                        <div class="text-xs text-red-600 mt-1">
                            ${transaction.debit ? formatNumber(transaction.debit) : ''}
                        </div>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-right">
                        <input type="text" value="${transaction.credit}" 
                               onchange="updateTransaction(${index}, 'credit', this.value)"
                               class="w-full p-1 border border-gray-200 rounded text-right focus:ring-1 focus:ring-green-500 focus:border-transparent"
                               placeholder="0">
                        <div class="text-xs text-gray-600 mt-1">
                            ${transaction.credit ? transaction.credit + ' %' : ''}
                        </div>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-right">
                        <div class="w-full p-1 border border-gray-100 rounded bg-gray-50 text-right text-green-700">
                            ${transaction.profitAmount ? formatNumber(transaction.profitAmount) : ''}
                        </div>
                    </td>
                    <td class="px-3 py-4">
                        ${createDropdownInput(transaction.channel, index, 'channel')}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-right font-medium ${balances[index] >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${formatNumber(balances[index])}
                    </td>
                    <td class="px-3 py-4">
                        ${createDropdownInput(transaction.detail, index, 'detail')}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-center no-print">
                        <button onclick="insertRow(${index})" 
                                class="text-blue-600 hover:text-blue-800 mr-2" 
                                title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà">‚ûï</button>
                        <button onclick="deleteRow(${index})" 
                                class="text-red-600 hover:text-red-800" 
                                title="‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateTransaction(index, field, value) {
            if (field === 'debit' || field === 'credit' || field === 'item') {
                transactions[index][field] = normalizeNumber(value);
            } else {
                transactions[index][field] = value;
            }
            renderTable();
            calculateTotalAllAccounts();
            saveUserData();
        }

        function addRow() {
            transactions.push({
                id: generateId(),
                date: "",
                item: "",
                debit: "",
                credit: "",
                channel: "",
                detail: "",
                profitAmount: 0
            });
            renderTable();
            calculateTotalAllAccounts();
            saveUserData();
        }

        function insertRow(index) {
            transactions.splice(index + 1, 0, {
                id: generateId(),
                date: "",
                item: "",
                debit: "",
                credit: "",
                channel: "",
                detail: "",
                profitAmount: 0
            });
            renderTable();
            calculateTotalAllAccounts();
            saveUserData();
        }

        function deleteRow(index) {
            if (transactions.length > 1) {
                transactions.splice(index, 1);
                renderTable();
                calculateTotalAllAccounts();
                saveUserData();
            } else {
                alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
            }
        }

        // ==========================
        // CSV Export / Import
        // ==========================
        function safeCSV(str) {
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        function exportCSV() {
            saveCurrentPageData();
            
            const header = ['page', 'date', 'deposit', 'withdraw', 'profit_percent', 'channel', 'detail'];
            const lines = [header.join(',')];
            
            Object.values(pages).forEach(page => {
                page.transactions.forEach(transaction => {
                    lines.push([
                        safeCSV(page.name),
                        transaction.date,
                        toNum(transaction.item).toFixed(2),
                        toNum(transaction.debit).toFixed(2),
                        toNum(transaction.credit).toFixed(2),
                        safeCSV(transaction.channel),
                        safeCSV(transaction.detail)
                    ].join(','));
                });
            });
            
            const csv = lines.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alphapatra-statement-${currentLoggedUser}-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const newTransactions = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const values = parseCSVLine(line);
                        if (values.length >= 7) {
                            newTransactions.push({
                                id: generateId(),
                                date: values[1],
                                item: values[2] === '0.00' ? '' : values[2],
                                debit: values[3] === '0.00' ? '' : values[3],
                                credit: values[4] === '0.00' ? '' : values[4],
                                channel: values[5],
                                detail: values[6],
                                profitAmount: 0
                            });
                        }
                    }
                    
                    if (newTransactions.length > 0) {
                        transactions = newTransactions;
                        pages[currentPageId].transactions = transactions;
                        renderTable();
                        saveUserData();
                        alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${newTransactions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                    }
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå CSV');
                }
            };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // ==========================
        // Logo
        // ==========================
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const logoImage = document.getElementById('logoImage');
                const logoText = document.getElementById('logoText');
                logoImage.src = e.target.result;
                logoImage.classList.remove('hidden');
                logoText.classList.add('hidden');
                localStorage.setItem('bankLogo', e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function loadSavedLogo() {
            const savedLogo = localStorage.getItem('bankLogo');
            if (savedLogo) {
                const logoImage = document.getElementById('logoImage');
                const logoText = document.getElementById('logoText');
                logoImage.src = savedLogo;
                logoImage.classList.remove('hidden');
                logoText.classList.add('hidden');
            }
        }

        // ==========================
        // Export ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û
        // ==========================
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('hidden');
            
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('#exportMenu') && !e.target.closest('button[onclick="toggleExportMenu()"]')) {
                    menu.classList.add('hidden');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        function loadHtml2Canvas() {
            return new Promise((resolve) => {
                if (window.html2canvas) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = resolve;
                document.head.appendChild(script);
            });
        }

        async function exportAsImage(format) {
            try {
                document.getElementById('exportMenu').classList.add('hidden');
                
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingExport';
                loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                loadingDiv.innerHTML = `
                    <div class="bg-white rounded-lg p-6 text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto mb-4"></div>
                        <p class="text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á...</p>
                    </div>
                `;
                document.body.appendChild(loadingDiv);
                
                await loadHtml2Canvas();
                
                const noPrintElements = document.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.style.display = 'none');
                
                const statementSection = document.getElementById('statementSection');
                const tempContainer = document.createElement('div');
                tempContainer.className = 'bg-gray-50 p-4';
                
                const headerClone = statementSection.children[1].cloneNode(true);
                tempContainer.appendChild(headerClone);
                
                const tableClone = statementSection.children[2].cloneNode(true);
                tempContainer.appendChild(tableClone);

                const profitClone = statementSection.children[3].cloneNode(true);
                tempContainer.appendChild(profitClone);

                const footerClone = statementSection.children[4].cloneNode(true);
                tempContainer.appendChild(footerClone);
                
                document.body.appendChild(tempContainer);
                const element = tempContainer;

                const rect = element.getBoundingClientRect();
                
                const options = {
                    backgroundColor: '#ffffff',
                    scale: 3,
                    useCORS: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0,
                    width: rect.width,
                    height: rect.height,
                    windowWidth: rect.width,
                    windowHeight: rect.height
                };
                
                const canvas = await html2canvas(element, options);
                
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `alphapatra-statement-${currentLoggedUser}-${pages[currentPageId].name}-${new Date().toISOString().slice(0,10)}.${format}`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    noPrintElements.forEach(el => el.style.display = '');
                    document.body.removeChild(tempContainer);
                    document.body.removeChild(loadingDiv);
                    
                    alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå ${format.toUpperCase()} (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                }, `image/${format}`, format === 'jpeg' ? 0.95 : 1.0);
                
            } catch (error) {
                console.error('Export error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û');
                
                const noPrintElements = document.querySelectorAll('.no-print');
                noPrintElements.forEach(el => el.style.display = '');
                
                const tempContainer = document.querySelector('div.bg-gray-50:last-child');
                if (tempContainer && tempContainer.parentNode === document.body) {
                    document.body.removeChild(tempContainer);
                }
                
                const loadingDiv = document.getElementById('loadingExport');
                if (loadingDiv) {
                    document.body.removeChild(loadingDiv);
                }
            }
        }

        // ==========================
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£ AlphaProfit
        // ==========================
        function calcProfit() {
            const totalInput = document.getElementById('ap_total');
            const fundInput = document.getElementById('ap_fund');
            const resultDiv = document.getElementById('ap_result');
            if (!totalInput || !fundInput || !resultDiv) return;

            const total = parseFloat(totalInput.value) || 0;
            const fund = parseFloat(fundInput.value) || 0;

            if (total === 0 && fund === 0) {
                resultDiv.classList.add('hidden');
                return;
            }

            const profit = total - fund;
            const half = profit / 2;
            const clientNet = fund + half;
            const managerNet = half;

            resultDiv.innerHTML = `
                <h4 class="text-base md:text-lg font-semibold text-gray-800 mb-3 text-center">
                    üìë ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£
                </h4>
                <div class="space-y-2 text-sm md:text-base">
                    <div class="flex justify-between border-b border-gray-200 pb-1">
                        <span class="text-gray-600">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        <span class="font-semibold text-gray-800">
                            ${total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó
                        </span>
                    </div>
                    <div class="flex justify-between border-b border-gray-200 pb-1">
                        <span class="text-gray-600">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
                        <span class="font-semibold text-gray-800">
                            ${fund.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó
                        </span>
                    </div>
                    <div class="flex justify-between border-b border-gray-200 pb-1">
                        <span class="text-gray-600">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                        <span class="font-semibold ${profit >= 0 ? 'text-emerald-600' : 'text-red-600'}">
                            ${profit.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó
                        </span>
                    </div>
                    <div class="flex justify-between border-b border-gray-200 pb-1">
                        <span class="text-gray-600">‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡∏Ñ‡∏ô‡∏•‡∏∞ (50/50)</span>
                        <span class="font-semibold text-indigo-600">
                            ${half.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó
                        </span>
                    </div>
                </div>
                <div class="mt-3 bg-white rounded-lg shadow-sm px-3 py-2 space-y-1">
                    <div class="flex justify-between text-sm md:text-base">
                        <span class="font-medium text-gray-700">üíé ‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
                        <span class="font-semibold text-emerald-600">
                            ${clientNet.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó
                        </span>
                    </div>
                    <div class="flex justify-between text-xs md:text-sm text-gray-600">
                        <span>‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</span>
                        <span>${half.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                    <div class="flex justify-between text-xs md:text-sm text-gray-600">
                        <span>‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏≠‡∏£‡πå‡∏ï</span>
                        <span>${managerNet.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                </div>
            `;

            resultDiv.classList.remove('hidden');
        }

        // ==========================
        // ‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
        // ==========================
        function calculateMonthlyProfitAllPages(year, month) {
            let totalProfit = 0;

            Object.values(pages).forEach(page => {
                let runningBalance = 0;

                (page.transactions || []).forEach(t => {
                    const deposit = toNum(t.item);
                    const withdraw = toNum(t.debit);
                    const profitPercent = toNum(t.credit);

                    const base = runningBalance;
                    let profitAmount = 0;

                    if (profitPercent !== 0) {
                        profitAmount = base * (profitPercent / 100);
                    }

                    if (t.date) {
                        const d = new Date(t.date);
                        const tYear = d.getFullYear();
                        const tMonth = d.getMonth() + 1;

                        if (tYear === year && tMonth === month) {
                            totalProfit += profitAmount;
                        }
                    }

                    runningBalance = base + deposit - withdraw + profitAmount;
                });
            });

            return totalProfit;
        }

        function updateMonthlyProfit() {
            const monthSelect = document.getElementById('monthlyMonth');
            const yearSelect  = document.getElementById('monthlyYear');
            const monthProfitEl = document.getElementById('overviewMonthlyProfit');
            const monthLabelEl  = document.getElementById('overviewMonthlyLabel');

            if (!monthSelect || !yearSelect || !monthProfitEl || !monthLabelEl) return;

            if (!monthSelect.value || !yearSelect.value) {
                const now = new Date();
                const defaultMonth = now.getMonth() + 1;
                const defaultYearTh = now.getFullYear() + 543;
                if (!monthSelect.value) monthSelect.value = defaultMonth.toString();
                if (!yearSelect.value)  yearSelect.value  = defaultYearTh.toString();
            }

            const month = parseInt(monthSelect.value, 10);
            const yearTh = parseInt(yearSelect.value, 10);
            if (!month || !yearTh) return;

            const year = yearTh - 543;

            const monthProfit = calculateMonthlyProfitAllPages(year, month);

            monthProfitEl.textContent = formatNumber(monthProfit);
            monthProfitEl.className =
                'text-lg font-semibold ' + (monthProfit >= 0 ? 'text-rose-700' : 'text-red-600');

            const monthNamesTh = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
                                  '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];

            monthLabelEl.textContent = `${monthNamesTh[month - 1]} ${yearTh}`;
        }

        // ==========================
        // Overview + Chart
        // ==========================
        function openOverview() {
            renderOverview();
            const modal = document.getElementById('overviewModal');
            modal.classList.remove('hidden');
        }

        function closeOverview() {
            const modal = document.getElementById('overviewModal');
            modal.classList.add('hidden');
        }

        function renderOverview() {
            const tbody = document.getElementById('overviewTableBody');
            const totalCustomersEl = document.getElementById('overviewTotalCustomers');
            const sumInitialEl = document.getElementById('overviewSumInitial');
            const sumFinalEl = document.getElementById('overviewSumFinal');
            const sumProfitEl = document.getElementById('overviewSumProfit');

            if (!tbody) return;

            const customers = Object.values(pages);
            const labels = [];
            const initialData = [];
            const finalData = [];
            const profitData = [];
            const roiData = [];

            let sumInitial = 0;
            let sumFinal = 0;
            let sumProfit = 0;

            tbody.innerHTML = customers.map((customer, index) => {
                const txs = customer.transactions || [];
                let initial = 0;
                txs.forEach(t => { initial += toNum(t.item); });
                const final = computeCustomerFinalBalance(txs);
                const profit = final - initial;
                const roi = initial > 0 ? (profit / initial) * 100 : 0;

                labels.push(customer.name || `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${index + 1}`);
                initialData.push(initial);
                finalData.push(final);
                profitData.push(profit);
                roiData.push(roi);

                sumInitial += initial;
                sumFinal += final;
                sumProfit += profit;

                return `
                    <tr class="border-b last:border-b-0">
                        <td class="px-2 py-1 text-xs text-gray-500">${index + 1}</td>
                        <td class="px-2 py-1 text-xs text-gray-800 font-medium">${customer.name}</td>
                        <td class="px-2 py-1 text-xs text-right text-gray-600">${formatNumber(initial)}</td>
                        <td class="px-2 py-1 text-xs text-right text-gray-600">${formatNumber(final)}</td>
                        <td class="px-2 py-1 text-xs text-right ${profit >= 0 ? 'text-emerald-600' : 'text-red-600'}">${formatNumber(profit)}</td>
                        <td class="px-2 py-1 text-xs text-right ${roi >= 0 ? 'text-indigo-600' : 'text-red-600'}">
                            ${isFinite(roi) ? roi.toFixed(2) : '0.00'} %
                        </td>
                    </tr>
                `;
            }).join('');

            if (totalCustomersEl) totalCustomersEl.textContent = customers.length;
            if (sumInitialEl) sumInitialEl.textContent = formatNumber(sumInitial);
            if (sumFinalEl) sumFinalEl.textContent = formatNumber(sumFinal);
            if (sumProfitEl) {
                sumProfitEl.textContent = formatNumber(sumProfit);
                sumProfitEl.className = 'text-lg font-semibold ' + (sumProfit >= 0 ? 'text-emerald-600' : 'text-red-600');
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏° dropdown
            updateMonthlyProfit();

            const chartCanvas = document.getElementById('overviewChart');
            if (!chartCanvas) return;

            const ctx = chartCanvas.getContext('2d');
            if (overviewChart) {
                overviewChart.destroy();
            }

            overviewChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏£‡∏ß‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î',
                            data: finalData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥',
                            data: profitData,
                            backgroundColor: 'rgba(79, 70, 229, 0.6)',
                            borderRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: '‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô (%)',
                            data: roiData,
                            borderColor: 'rgb(249, 115, 22)',
                            backgroundColor: 'rgba(249, 115, 22, 0.2)',
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dsLabel = context.dataset.label || '';
                                    const value = context.raw;
                                    if (dsLabel.includes('%')) {
                                        return `${dsLabel}: ${value.toFixed(2)} %`;
                                    }
                                    return `${dsLabel}: ${value.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            position: 'left',
                            title: { display: true, text: '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ (‡∏ö‡∏≤‡∏ó)' },
                            ticks: {
                                callback: (value) => value.toLocaleString('th-TH')
                            }
                        },
                        y1: {
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: '‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô (%)' },
                            ticks: {
                                callback: (value) => value + '%'
                            }
                        }
                    }
                }
            });
        }

        // ==========================
        // Auto-save & Init
        // ==========================
        setInterval(() => {
            if (currentLoggedUser) {
                saveUserData();
            }
        }, 30000);

        loadUserData();
        renderCustomerList();
        renderTable();
        loadSavedLogo();
    </script>
</body>
</html>

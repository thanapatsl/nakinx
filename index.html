<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AlphaPatra - ‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Sarabun', sans-serif; background:#f8fafc; }
    @media print {
      .no-print { display: none !important; }
      .customer-list-section { display: none !important; }
      body { font-size: 12px; }
      .print-table { font-size: 11px; }
      .page-break { page-break-after: always; }
    }
    /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™‡∏à‡∏≤‡∏Å kbank-* -> alphapatra-* */
    .alphapatra-green { background-color: #138f2d; }
    .alphapatra-green-light { background-color: #e8f5e8; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
  </style>
</head>
<body class="min-h-screen">

  <!-- ‡πÅ‡∏≠‡∏õ‡∏´‡∏•‡∏±‡∏Å -->
  <div id="mainApp" class="container mx-auto p-4 max-w-7xl">
    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
    <div id="customerDashboard" class="bg-white rounded-lg shadow-lg mb-6 p-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-blue-600 rounded-lg flex items-center justify-center">
            <span class="text-white font-bold text-xl">üíº</span>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h1>
            <p class="text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <div class="text-right">
            <div class="text-sm text-gray-500">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="text-2xl font-bold text-blue-600" id="customerCount">0</div>
          </div>
          <button onclick="addNewCustomer()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center space-x-2 shadow-lg">
            <span class="text-lg">‚ûï</span><span class="font-medium">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
          </button>
        </div>
      </div>
      <div id="customerList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) -->
    <div id="statementSection" class="hidden">
      <!-- ‡πÅ‡∏ñ‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á -->
      <div class="bg-white rounded-lg shadow-lg mb-4 p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <button onclick="showCustomerList()"
              class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center space-x-2">
              <span>‚Üê</span><span>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </button>
            <div class="h-6 w-px bg-gray-300"></div>
            <div>
              <h2 class="text-lg font-semibold text-gray-800" id="currentCustomerName">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
              <p class="text-sm text-gray-600">‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å</p>
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="renameCurrentCustomer()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">‚úèÔ∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠</button>
            <button onclick="deleteCurrentCustomer()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">üóëÔ∏è ‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
          </div>
        </div>
      </div>

      <!-- ‚úÖ ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏£‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û -->
      <div id="statementCapture">
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
        <div class="bg-white rounded-lg shadow-lg mb-6 p-6">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
              <div class="relative">
                <div id="logoContainer" class="w-12 h-12 alphapatra-green rounded-lg flex items-center justify-center cursor-pointer hover:bg-green-700 transition-colors"
                     onclick="document.getElementById('logoInput').click()">
                  <span id="logoText" class="text-white font-bold text-xl">A</span>
                  <img id="logoImage" class="w-12 h-12 rounded-lg object-cover hidden" alt="AlphaPatra Logo">
                </div>
                <input type="file" id="logoInput" accept="image/*" style="display:none" onchange="handleLogoUpload(event)">
              </div>
              <input id="reportTitle" value="‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å"
                     class="text-2xl font-bold text-gray-800 bg-transparent border-none focus:outline-none focus:ring-2 focus:ring-green-500 focus:bg-white rounded px-2 py-1"/>
            </div>

            <div class="no-print flex space-x-2">
              <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å -->
              <div class="relative">
                <button onclick="toggleExportMenu()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                  üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
                  <svg class="ml-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
                <div id="exportMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                  <div class="py-2">
                    <button onclick="exportAsImage('png')"  class="w-full text-left px-4 py-2 hover:bg-gray-100">üñºÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PNG</button>
                    <button onclick="exportAsImage('jpeg')" class="w-full text-left px-4 py-2 hover:bg-gray-100">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô JPEG</button>
                    <hr class="my-1">
                    <button onclick="exportCSV()" class="w-full text-left px-4 py-2 hover:bg-gray-100">üìä Export CSV</button>
                    <button onclick="window.print()" class="w-full text-left px-4 py-2 hover:bg-gray-100">üñ®Ô∏è Print PDF</button>
                  </div>
                </div>
              </div>

              <input type="file" id="csvInput" accept=".csv" style="display:none" onchange="importCSV(event)">
              <button onclick="document.getElementById('csvInput').click()"
                      class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üìÅ Import CSV</button>
            </div>
          </div>

          <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏• -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô</label>
              <input id="bankName" value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏±‡∏•‡∏ü‡πà‡∏≤‡∏†‡∏±‡∏ó‡∏£"
                     class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏´‡∏∏‡πâ‡∏ô</label>
              <input id="accountNo" value="XXX-X-XXXXX-X"
                     class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"/>
            </div>
          </div>

          <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î -->
          <div class="mt-4 flex justify-between items-start">
            <div class="flex space-x-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                <div id="initialInvestment" class="w-64 p-3 bg-red-50 border-2 border-red-300 rounded-lg text-center font-bold text-lg text-red-700">0.00</div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
                <div id="finalBalance" class="w-64 p-3 bg-green-50 border-2 border-green-300 rounded-lg text-center font-bold text-lg text-green-700">0.00</div>
              </div>
            </div>
            <div class="text-right text-sm text-gray-700">
              <div class="font-semibold text-green-700 mb-1">‡∏≠‡∏±‡∏•‡∏ü‡πà‡∏≤‡∏†‡∏±‡∏ó‡∏£ AlphaPatra</div>
              <div>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 85/1 ‡∏´‡∏°‡∏π‡πà 12 ‡∏ï‡∏≥‡∏ö‡∏•‡∏™‡∏∞‡πÅ‡∏Å</div>
              <div>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏™‡∏ï‡∏∂‡∏Å ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå 31150</div>
              <div class="font-medium text-blue-600">(0863019724)</div>
            </div>
          </div>
        </div>

        <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏° -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <div class="p-4 alphapatra-green-light border-b">
            <div class="flex justify-between items-center">
              <h2 class="text-lg font-semibold text-gray-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h2>
              <button onclick="addRow()" class="no-print bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full print-table">
              <thead class="alphapatra-green text-white">
                <tr>
                  <th class="px-3 py-3 text-left text-xs font-medium uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th class="px-3 py-3 text-left text-xs font-medium uppercase">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                  <th class="px-3 py-3 text-right text-xs font-medium uppercase">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å</th>
                  <th class="px-3 py-3 text-right text-xs font-medium uppercase">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤</th>
                  <th class="px-3 py-3 text-left text-xs font-medium uppercase">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                  <th class="px-3 py-3 text-left text-xs font-medium uppercase">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                  <th class="px-3 py-3 text-right text-xs font-medium uppercase">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                  <th class="px-3 py-3 text-center text-xs font-medium uppercase no-print">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="transactionTable" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div> <!-- /#statementCapture -->
    </div>
  </div>

  <!-- ====== ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÅ‡∏≠‡∏õ ====== -->
  <script>
    let currentLoggedUser = 'admin';
    let currentUserRole = 'admin';

    let currentPageId = 1;
    let pages = {};
    let transactions = [];

    function generateId(){ return Date.now().toString(36)+Math.random().toString(36).substr(2); }

    function saveUserData(){
      saveCurrentPageData();
      localStorage.setItem('pages', JSON.stringify(pages));
      localStorage.setItem('currentPageId', String(currentPageId));
    }
    function loadUserData(){
      const savedPages = localStorage.getItem('pages');
      const savedCurrentPageId = localStorage.getItem('currentPageId');
      if (savedPages){
        pages = JSON.parse(savedPages);
        currentPageId = savedCurrentPageId ? parseInt(savedCurrentPageId) : Number(Object.keys(pages)[0]);
      } else {
        currentPageId = 1;
        pages = {
          1: {
            id: 1, name: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 1",
            reportTitle: "‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å",
            bankName: "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏±‡∏•‡∏ü‡πà‡∏≤‡∏†‡∏±‡∏ó‡∏£",
            accountNo: "XXX-X-XXXXX-X",
            transactions: [ { id: generateId(), date:"", item:"", debit:"", credit:"", channel:"", detail:"" } ]
          }
        };
      }
      transactions = pages[currentPageId].transactions;
      loadPageData();
    }

    function showCustomerList(){
      document.getElementById('customerDashboard').style.display = 'block';
      document.getElementById('statementSection').classList.add('hidden');
    }
    function showStatementView(customerId){
      document.getElementById('customerDashboard').style.display = 'none';
      document.getElementById('statementSection').classList.remove('hidden');
      const customer = pages[customerId];
      document.getElementById('currentCustomerName').textContent = customer.name;
      switchToCustomer(customerId);
    }

    function renderCustomerList(){
      const wrap = document.getElementById('customerList');
      document.getElementById('customerCount').textContent = Object.keys(pages).length;
      wrap.innerHTML = Object.values(pages).map((c, idx)=>`
        <div class="bg-gradient-to-br from-white to-gray-50 border-2 border-gray-200 rounded-xl p-6 transition-all hover:shadow-lg hover:border-blue-300 cursor-pointer group"
             onclick="showStatementView(${c.id})">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full flex items-center justify-center text-lg font-bold shadow-lg">${idx+1}</div>
              <div>
                <div class="font-bold text-gray-800 text-lg group-hover:text-blue-600">${c.name}</div>
                <div class="text-sm text-gray-500">ID: ${c.id}</div>
              </div>
            </div>
            <div class="flex space-x-2">
              <button onclick="renameCustomer(${c.id}); event.stopPropagation();" class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠">‚úèÔ∏è</button>
              ${Object.keys(pages).length>1?`<button onclick="deleteCustomer(${c.id}); event.stopPropagation();" class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50" title="‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">üóëÔ∏è</button>`:''}
            </div>
          </div>
          <div class="border-t border-gray-200 pt-4">
            <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
              <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span><span class="font-semibold">${c.transactions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="flex items-center justify-between text-sm text-gray-600">
              <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span><span>${new Date().toLocaleDateString('th-TH')}</span>
            </div>
          </div>
          <div class="mt-4 flex items-center justify-center">
            <div class="bg-green-100 text-green-700 px-4 py-2 rounded-lg font-medium group-hover:bg-green-200">üìä ‡∏î‡∏π‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
          </div>
        </div>
      `).join('');
    }
    function addNewCustomer(){
      const count = Object.keys(pages).length+1;
      const name = prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà:', `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${count}`);
      if(!name||!name.trim()) return;
      const newId = Math.max(...Object.keys(pages).map(Number))+1;
      pages[newId] = {
        id:newId, name:name.trim(),
        reportTitle:"‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å",
        bankName:name.trim(),
        accountNo:"",
        transactions:[{ id:generateId(), date:"", item:"", debit:"", credit:"", channel:"", detail:"" }]
      };
      renderCustomerList(); saveUserData(); showStatementView(newId);
    }
    function renameCustomer(id){
      const cur = pages[id].name;
      const n = prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:', cur);
      if(n && n.trim() && n.trim()!==cur){ pages[id].name = n.trim(); renderCustomerList(); saveUserData(); }
    }
    function renameCurrentCustomer(){ renameCustomer(currentPageId); document.getElementById('currentCustomerName').textContent = pages[currentPageId].name; }
    function deleteCustomer(id){
      if(Object.keys(pages).length<=1){ alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô'); return; }
      if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ "${pages[id].name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£`)){
        delete pages[id]; renderCustomerList(); saveUserData();
      }
    }
    function deleteCurrentCustomer(){
      if(Object.keys(pages).length<=1){ alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô'); return; }
      if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ "${pages[currentPageId].name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£`)){
        delete pages[currentPageId];
        const remain = Object.keys(pages); currentPageId = parseInt(remain[0]);
        transactions = pages[currentPageId].transactions; saveUserData();
        showCustomerList(); renderCustomerList();
      }
    }
    function switchToCustomer(id){
      saveCurrentPageData(); currentPageId = id; transactions = pages[id].transactions;
      loadPageData(); renderTable(); saveUserData();
    }

    function saveCurrentPageData(){
      if(pages[currentPageId]){
        pages[currentPageId].reportTitle = document.getElementById('reportTitle').value;
        pages[currentPageId].bankName    = document.getElementById('bankName').value;
        pages[currentPageId].accountNo   = document.getElementById('accountNo').value;
        pages[currentPageId].transactions = [...transactions];
      }
    }
    function loadPageData(){
      const p = pages[currentPageId];
      document.getElementById('reportTitle').value = p.reportTitle;
      document.getElementById('bankName').value    = p.bankName;
      document.getElementById('accountNo').value   = p.accountNo;
      setTimeout(()=>{ calculateBalances(); },100);
    }

    const toNum = (v)=> (v===""||v==null)?0:(isNaN(parseFloat(String(v).replace(/,/g,'')))?0:parseFloat(String(v).replace(/,/g,'')));
    function formatNumber(n){ if(n===""||isNaN(Number(n))) return ""; return Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function normalizeNumber(val){ if(val==="") return ""; const cleaned=val.replace(/[^0-9.]/g,""); const parts=cleaned.split("."); return parts.length>2?parts[0]+"."+parts.slice(1).join(""):cleaned; }

    function calculateBalances(){
      let initialInvestment = 0;
      if(transactions.length>0){
        const firstCredit = toNum(transactions[0].credit);
        if(firstCredit>0) initialInvestment = firstCredit;
      }
      document.getElementById('initialInvestment').textContent = formatNumber(initialInvestment);

      let running = 0;
      const balances = [];
      transactions.forEach((t,i)=>{ running = running - toNum(t.debit) + toNum(t.credit); balances[i]=running; });
      updateFinalBalance(balances);
      return balances;
    }
    function updateFinalBalance(balances){
      const el = document.getElementById('finalBalance');
      const last = balances.length?balances[balances.length-1]:0;
      el.textContent = formatNumber(last);
      el.className = 'w-64 p-3 rounded-lg text-center font-bold text-lg border-2 '+(last>=0?'bg-green-50 border-green-300 text-green-700':'bg-red-50 border-red-300 text-red-700');
    }

    function renderTable(){
      const tbody = document.getElementById('transactionTable');
      const balances = calculateBalances();
      tbody.innerHTML = transactions.map((t,i)=>`
        <tr class="hover:bg-gray-50">
          <td class="px-3 py-4 whitespace-nowrap">
            <input type="date" value="${t.date}" onchange="updateTransaction(${i},'date',this.value)"
                   class="w-full p-1 border border-gray-200 rounded focus:ring-1 focus:ring-green-500 focus:border-transparent"/>
          </td>
          <td class="px-3 py-4">
            <input type="text" value="${t.item}" onchange="updateTransaction(${i},'item',this.value)"
                   class="w-full p-1 border border-gray-200 rounded focus:ring-1 focus:ring-green-500 focus:border-transparent"/>
          </td>
          <td class="px-3 py-4 whitespace-nowrap text-right">
            <input type="text" value="${t.debit}" onchange="updateTransaction(${i},'debit',this.value)"
                   class="w-full p-1 border border-gray-200 rounded text-right focus:ring-1 focus:ring-green-500 focus:border-transparent" placeholder="0.00"/>
            <div class="text-xs text-red-600 mt-1">${t.debit?formatNumber(t.debit):''}</div>
          </td>
          <td class="px-3 py-4 whitespace-nowrap text-right">
            <input type="text" value="${t.credit}" onchange="updateTransaction(${i},'credit',this.value)"
                   class="w-full p-1 border border-gray-200 rounded text-right focus:ring-1 focus:ring-green-500 focus:border-transparent" placeholder="0.00"/>
            <div class="text-xs text-green-600 mt-1">${t.credit?formatNumber(t.credit):''}</div>
          </td>
          <td class="px-3 py-4">
            <input type="text" value="${t.channel}" onchange="updateTransaction(${i},'channel',this.value)"
                   class="w-full p-1 border border-gray-200 rounded focus:ring-1 focus:ring-green-500 focus:border-transparent"/>
          </td>
          <td class="px-3 py-4">
            <input type="text" value="${t.detail}" onchange="updateTransaction(${i},'detail',this.value)"
                   class="w-full p-1 border border-gray-200 rounded focus:ring-1 focus:ring-green-500 focus:border-transparent"/>
          </td>
          <td class="px-3 py-4 whitespace-nowrap text-right font-medium ${balances[i]>=0?'text-green-600':'text-red-600'}">
            ${formatNumber(balances[i])}
          </td>
          <td class="px-3 py-4 whitespace-nowrap text-center no-print">
            <button onclick="insertRow(${i})" class="text-blue-600 hover:text-blue-800 mr-2" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß">‚ûï</button>
            <button onclick="deleteRow(${i})" class="text-red-600 hover:text-red-800" title="‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }
    function updateTransaction(i,field,value){
      if(field==='debit' || field==='credit'){ transactions[i][field] = normalizeNumber(value); }
      else { transactions[i][field] = value; }
      renderTable(); calculateBalances(); saveUserData();
    }
    function addRow(){
      transactions.push({ id:generateId(), date:"", item:"", debit:"", credit:"", channel:"", detail:"" });
      renderTable(); calculateBalances(); saveUserData();
    }
    function insertRow(i){
      transactions.splice(i+1,0,{ id:generateId(), date:"", item:"", debit:"", credit:"", channel:"", detail:"" });
      renderTable(); calculateBalances(); saveUserData();
    }
    function deleteRow(i){
      if(transactions.length>1){ transactions.splice(i,1); renderTable(); calculateBalances(); saveUserData(); }
      else alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    }

    function safeCSV(s){ return (s.includes(',')||s.includes('"')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s; }
    function exportCSV(){
      saveCurrentPageData();
      const header = ['page','date','item','debit','credit','channel','detail'];
      const lines = [header.join(',')];
      Object.values(pages).forEach(p=>{
        p.transactions.forEach(t=>{
          lines.push([
            safeCSV(p.name), t.date, safeCSV(t.item),
            toNum(t.debit).toFixed(2), toNum(t.credit).toFixed(2),
            safeCSV(t.channel), safeCSV(t.detail)
          ].join(','));
        });
      });
      const csv = lines.join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `alphapatra-statement-${currentLoggedUser}-${new Date().toISOString().slice(0,10)}.csv`;
      a.click(); URL.revokeObjectURL(url);
    }
    function importCSV(e){
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const csv = ev.target.result; const lines = csv.split('\n'); const rows=[];
          for(let i=1;i<lines.length;i++){
            const line = lines[i].trim(); if(!line) continue;
            const vals = parseCSVLine(line);
            if(vals.length>=6){
              rows.push({ id:generateId(), date:vals[0], item:vals[1],
                debit: vals[2]==='0.00'?'':vals[2], credit: vals[3]==='0.00'?'':vals[3],
                channel: vals[4], detail: vals[5] });
            }
          }
          if(rows.length){ transactions = rows; renderTable(); saveUserData(); alert(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß`); }
        }catch(err){ alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV'); }
      };
      reader.readAsText(file);
    }
    function parseCSVLine(line){
      const res=[]; let cur=''; let q=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } }
        else if(ch===',' && !q){ res.push(cur); cur=''; }
        else cur+=ch;
      }
      res.push(cur); return res;
    }

    function handleLogoUpload(e){
      const f=e.target.files[0]; if(!f) return;
      if(!f.type.startsWith('image/')){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'); return; }
      if(f.size>5*1024*1024){ alert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB'); return; }
      const r=new FileReader();
      r.onload=(ev)=>{
        const img=document.getElementById('logoImage');
        const txt=document.getElementById('logoText');
        img.src=ev.target.result; img.classList.remove('hidden'); txt.classList.add('hidden');
        localStorage.setItem('alphaPatraLogo', ev.target.result);
      };
      r.readAsDataURL(f);
    }
    function loadSavedLogo(){
      const saved=localStorage.getItem('alphaPatraLogo');
      if(saved){
        const img=document.getElementById('logoImage'); const txt=document.getElementById('logoText');
        img.src=saved; img.classList.remove('hidden'); txt.classList.add('hidden');
      }
    }

    function toggleExportMenu(){
      const m=document.getElementById('exportMenu'); m.classList.toggle('hidden');
      document.addEventListener('click', function closeMenu(e){
        if(!e.target.closest('#exportMenu') && !e.target.closest('button[onclick="toggleExportMenu()"]')){
          m.classList.add('hidden'); document.removeEventListener('click', closeMenu);
        }
      });
    }

    function loadHtml2Canvas(){
      return new Promise((resolve)=>{
        if(window.html2canvas){ resolve(); return; }
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        s.onload=resolve; document.head.appendChild(s);
      });
    }

    /* ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å DOM ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á #statementCapture */
    async function exportAsImage(format){
      try{
        document.getElementById('exportMenu')?.classList.add('hidden');
        await loadHtml2Canvas();
        if(document.fonts && document.fonts.ready){ try{ await document.fonts.ready; }catch(e){} }

        const noPrintEls = document.querySelectorAll('.no-print');
        noPrintEls.forEach(el=>{ el.dataset.__prevDisplay = el.style.display || ''; el.style.display='none'; });

        const element = document.getElementById('statementCapture');
        if(!element){
          noPrintEls.forEach(el=> el.style.display = el.dataset.__prevDisplay);
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); return;
        }

        const prevBg = element.style.backgroundColor;
        element.style.backgroundColor = '#ffffff';

        const canvas = await html2canvas(element, {
          backgroundColor:'#ffffff', scale:2, useCORS:true, allowTaint:true, scrollX:0, scrollY:0
        });

        noPrintEls.forEach(el=> el.style.display = el.dataset.__prevDisplay);
        element.style.backgroundColor = prevBg;

        canvas.toBlob((blob)=>{
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const nameSafe = pages[currentPageId]?.name || 'customer';
          a.href=url; a.download=`alphapatra-statement-${currentLoggedUser}-${nameSafe}-${new Date().toISOString().slice(0,10)}.${format}`;
          a.click(); URL.revokeObjectURL(url);
          alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå ${format.toUpperCase()} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
        }, `image/${format}`, format==='jpeg'?0.92:1.0);

      }catch(err){
        console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û');
      }
    }

    setInterval(()=>{ if(currentLoggedUser){ saveUserData(); } }, 30000);

    loadUserData(); renderCustomerList(); renderTable(); loadSavedLogo();
  </script>
</body>
</html>
